{
  "name": "Resilient Location Matching & Dynamic OData Routing",
  "description": "A deterministic, cascading exact-match engine for Power Automate. Designed to handle historical data inconsistencies, formatting anomalies, and region-specific outliers without relying on probabilistic matching, ensuring zero false-positive role assignments.",
  "core_logic_components": {
    "1_RegionalExceptions": {
      "step_name": "AlternateLVOILocation",
      "description": "Hardcoded routing logic to catch known historical data entry anomalies and map them to their strict canonical SharePoint location strings.",
      "expression": "if(contains(outputs('RegionLower'), 'hutt central'), '08-WGN Lower Hutt',\n  if(contains(outputs('RegionLower'), 'adelaide road'), '08-WGN Wellington - Mount Cook',\n    if(equals(outputs('RegionLower'), 'hamilton'), '03-WKO Hamilton - Hamilton Central',\n      if(contains(outputs('RegionLower'), 'henderson'), '02-AUK Auckland - Henderson',\n        if(contains(outputs('RegionLower'), 'aranui'), '12-CAN Christchurch - Aranui',\n          if(contains(outputs('RegionLower'), 'middleton'), '12-CAN Christchurch - Middleton',\n            if(contains(outputs('RegionLower'), 'mount/papamoa'), '04-BOP Tauranga - Papamoa',\n              if(contains(outputs('RegionLower'), 'onekawa'), '05-HBG Napier - Onekawa',\n                if(contains(outputs('RegionLower'), 'whangƒÅrei'), '01-NTL Whangarei',\n                  if(contains(outputs('RegionLower'), 'paraparaumu'), '08-WGN Paraparaumu',\n                    ''\n                  )\n                )\n              )\n            )\n          )\n        )\n      )\n    )\n  )\n)"
    },
    "2_DynamicFilterQueryBuilder": {
      "step_name": "LVOI_Name_FilterPreview",
      "description": "Dynamically constructs a complex OData Filter Query string based on the cascading conditions of the input data (e.g., checking if the role is 'around the community', a city-level region, or an exact suburb match), safely injecting the escaped exception variables only when they exist.",
      "expression": "if(\n  equals(toLower(trim(outputs('CityTownAscii'))),'around the community'),\n  concat(\n    'Opportunity_x0020_NameId eq ',\n    string(coalesce(triggerOutputs()?['body/Opportunity_x0020_NameId'], outputs('Get_item')?['body/Opportunity_x0020_Name#Id'])),\n    ' and (',\n      'NEWLocation eq ''', outputs('LVOILocationWithDashEsc'), '''',\n      ' or NEWLocation eq ''', outputs('LVOILocationNoDashEsc'), '''',\n      ' or NEWLocation eq ''', outputs('LVOILocationEscaped3'), '''',\n      if(equals(outputs('AlternateLVOILocationEscaped'), ''), '', concat(' or NEWLocation eq ''', outputs('AlternateLVOILocationEscaped'), '''')),\n      if(\n        equals(trim(coalesce(outputs('CityPrefixEscaped'),'')), ''),\n        '',\n        concat(' or startswith(NEWLocation, ''', outputs('CityPrefixEscaped'), ''')')\n      ),\n    ')'\n  ),\n  if(\n    outputs('IsCityLevelRegion'),\n    concat(\n      'Opportunity_x0020_NameId eq ',\n      string(coalesce(triggerOutputs()?['body/Opportunity_x0020_NameId'], outputs('Get_item')?['body/Opportunity_x0020_Name#Id'])),\n      ' and (NEWLocation eq ''',\n      outputs('CityLevelLVOILocationWantedEsc'),\n      '''',\n      if(equals(outputs('AlternateLVOILocationEscaped'), ''), '', concat(' or NEWLocation eq ''', outputs('AlternateLVOILocationEscaped'), '''')),\n      ')'\n    ),\n    concat(\n      'Opportunity_x0020_NameId eq ',\n      string(coalesce(triggerOutputs()?['body/Opportunity_x0020_NameId'], outputs('Get_item')?['body/Opportunity_x0020_Name#Id'])),\n      ' and (',\n        'NEWLocation eq ''', outputs('LVOILocationWithDashEsc'), '''',\n        ' or NEWLocation eq ''', outputs('LVOILocationNoDashEsc'), '''',\n        ' or NEWLocation eq ''', outputs('LVOILocationEscaped3'), '''',\n        if(equals(outputs('AlternateLVOILocationEscaped'), ''), '', concat(' or NEWLocation eq ''', outputs('AlternateLVOILocationEscaped'), '''')),\n        if(\n          equals(trim(coalesce(outputs('CityPrefixEscaped'),'')), ''),\n          '',\n          concat(\n            ' or (startswith(NEWLocation, ''', outputs('CityPrefixEscaped'), ''') and (',\n              'substringof('' - ', outputs('CityTownAsciiEscaped'), ''', NEWLocation) or ',\n              'substringof('' ', outputs('CityTownAsciiEscaped'), ''', NEWLocation)',\n            '))'\n          )\n        ),\n      ')'\n    )\n  )\n)"
    }
  }
}
